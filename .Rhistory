#   `InvasiveClosestCircumferentialMargin`==99 &`ResectionMarginInvasiveInSitu`=="Negative"~">=2mm margin",
#   `InvasiveClosestCircumferentialMargin` ==999 & `ResectionMarginInvasiveInSitu`=="Negative"
# ~ "Clear but unspecified margin",
# is.na(`InvasiveClosestCircumferentialMargin`) & `ResectionMarginInvasiveInSitu`=="Negative"
# ~ "Clear but unspecified margin",
# `InvasiveClosestCircumferentialMargin` %in% c(99,999) & `ResectionMarginInvasiveInSitu`=="Positive" ~"Involved margin",
# is.na(`InvasiveClosestCircumferentialMargin`) & `ResectionMarginInvasiveInSitu`=="Positive" ~"Involved margin",
# `InvasiveTumourSize`==0 & `ResectionMarginInvasiveInSitu`=="Negative" ~ "Clear but unspecified margin",
# PrimarySurgery=="No" ~ "No primary surgery",
# is.na(`InvasiveClosestCircumferentialMargin`) ~ "No Margin" )
# ,levels=levels.MarginGroup)
# ,DCISMarginGroup=factor(case_when(
#   `DcisClosestCircumferentialMargin`==0 ~"Involved margin",
#   `DcisClosestCircumferentialMargin`<1 ~"1mm margin",
#   `DcisClosestCircumferentialMargin`<99 ~">=2mm margin",
#   `DcisClosestCircumferentialMargin`==99 &`ResectionMarginInvasiveInSitu`=="Negative"~">=2mm margin",
#   `DcisClosestCircumferentialMargin` ==999 & `ResectionMarginInvasiveInSitu`=="Negative" ~"Clear but unspecified margin",
#   is.na(`DcisClosestCircumferentialMargin`) & `ResectionMarginInvasiveInSitu`=="Negative" ~"Clear but unspecified margin",
#   `DcisClosestCircumferentialMargin` %in% c(99,999) & `ResectionMarginInvasiveInSitu`=="Positive" ~"Involved margin",
#   is.na(`DcisClosestCircumferentialMargin`) & `ResectionMarginInvasiveInSitu`=="Positive" ~"Involved margin",
#   `DcisTumourSize`==0 & `ResectionMarginInvasiveInSitu`=="Negative" ~ "Clear but unspecified margin",
#   PrimarySurgery=="No" ~ "No primary surgery",
#   is.na(`DcisClosestCircumferentialMargin`) ~ "No Margin")
#   ,levels=levels.MarginGroup)
# ,`Adjuvant Radiation Therapy`=factor(`Adjuvant Radiation Therapy`, levels=levels.AdjuvantTherapies, labels=labels.AdjuvantTherapies)
# ,AdjRadioCategories = factor(case_when(str_detect(`Adjuvant Radiation Therapy`, 'Therapy received') ~ 'Therapy received',
#                                        str_detect(`Adjuvant Radiation Therapy`, 'Referred - ') ~ 'Referred but not used',
#                                        str_detect(`Adjuvant Radiation Therapy`, 'Not referred - ') ~ 'Not prescribed',
#                                        TRUE~'Other')
#                              ,levels.Adj3Cat, label=labels.Adj3Cat)
# ,MdtSurgeries=case_when(str_detect(MdtAgreedPlannedCancerTreatment, '6')~'MDT Surgery',
#                         TRUE~'MDT - Not surgery')
,SurgeryDateDefined=case_when(is.na(`DateOfSurgery`)~'Surgery date missing',
TRUE~'Surgery date recorded')
# ,TimeBetweenNeoStartAndSurgery=floor(as.numeric(difftime(`DateOfSurgery`, `Neoadj-Hormone Start Date`, units='weeks')))
# ,EndoBridge=factor(case_when(TimeBetweenNeoStartAndSurgery<=12 ~ 'Yes',
#                              `Neo-adjuvant Hormone Therapy`%in% c('Yes','Therapy received')
#                              & TimeBetweenNeoStartAndSurgery>12
#                              & MdmCancerPlanIntent=='Curative'
#                              & str_detect(MdtAgreedPlannedCancerTreatment, '6')
#                              & !(is.na(`DateOfSurgery`)) ~ 'Yes',
#                              `Neo-adjuvant Hormone Therapy`%in% c('Yes','Therapy received')~'Not bridge',
#                              TRUE~'No Neo-adjuvant Endocrine Therapy')
#                    ,levels=levels.EndoBridge, labels=labels.EndoBridge)
# ,HormoCatWithAblation=case_when(str_detect(`Ovarian Ablation`, 'Yes')  ~ 'Yes',
#                                 TRUE~`Adjuvant Hormone Therapy`)
# ,AdjHormoCat = factor(case_when(str_detect(HormoCatWithAblation, 'Yes') ~ 'Therapy received',
#                                 str_detect(HormoCatWithAblation, 'Referred - ') ~ 'Referred but not used',
#                                 str_detect(HormoCatWithAblation, 'Not referred - ') ~ 'Not prescribed',
#                                 TRUE~'Other'), levels=levels.Adj3Cat, labels=labels.Adj3Cat)
,`Adjuvant Hormone Therapy`=factor(`AdjuvantHormoneTherapy`, levels=levels.AdjuvantTherapies, labels=labels.AdjuvantTherapies)
# ,HER2Result=factor(HER2Result)
# ,`Ovarian Ablation`=factor(`Ovarian Ablation`)
# ,AdjChemoCategories = factor(case_when(`Adjuvant Chemotherapy` %in% c('Yes', 'Therapy received') ~ 'Therapy received',
#                                        str_detect(`Adjuvant Chemotherapy`, 'Referred - ') ~ 'Referred but not used',
#                                        str_detect(`Adjuvant Chemotherapy`, 'Not referred - ') ~ 'Not prescribed',
#                                        TRUE~'Other')
#                              ,levels=levels.Adj3Cat, labels=labels.Adj3Cat)
# ,`Adjuvant Chemotherapy`=factor(`Adjuvant Chemotherapy`, levels=levels.AdjuvantTherapies, labels=labels.AdjuvantTherapies)
# ,`Neo-adjuvant Radiation Therapy`=factor(`Neo-adjuvant Radiation Therapy`)
# ,NeoAdjRadioCategories = case_when(str_detect(`Neo-adjuvant Radiation Therapy`, 'Yes') ~ 'Radiotherapy  received',
#                                    str_detect(`Neo-adjuvant Radiation Therapy`, 'Referred - ') ~ 'Referred but not used',
#                                    str_detect(`Neo-adjuvant Radiation Therapy`, 'Not referred - ') ~ 'No Radiotherapy prescribed',
#                                    TRUE~'Other')
# ,TimeBetweenNeoStartAndSurgery=floor(as.numeric(difftime(`DateOfSurgery`, `Neoadj-Hormone Start Date`, units='weeks')))
# ,NeoAdjHormoCat = factor(case_when(str_detect(`Neo-adjuvant Hormone Therapy`, 'Yes') ~ "Therapy received",
#                                    str_detect(`Neo-adjuvant Hormone Therapy`, 'Referred - ')   ~ "Referred but not used",
#                                    str_detect(`Neo-adjuvant Hormone Therapy`, 'Not referred - ') ~ "Not prescribed",
#                                    TRUE~"Other")
#                          ,levels=levels.Adj3Cat, labels=labels.Adj3Cat)
# ,`Neo-adjuvant Hormone Therapy`=factor(`Neo-adjuvant Hormone Therapy`, levels = levels.AdjuvantHormoneTherapies, labels=labels.AdjuvantHormoneTherapies)
# ,`Neo-adjuvant Chemotherapy`=factor(`Neo-adjuvant Chemotherapy`, levels=levels.AdjuvantTherapies, labels=labels.AdjuvantTherapies)
# ,NeoAdjChemoCategories = factor(case_when(str_detect(`Neo-adjuvant Chemotherapy`, 'Yes')|str_detect(`Neo-adjuvant Chemotherapy`, 'Therapy received') ~ 'Therapy received',
#                                           str_detect(`Neo-adjuvant Chemotherapy`, 'Referred - ') ~ 'Referred but not used',
#                                           str_detect(`Neo-adjuvant Chemotherapy`, 'Not referred - ') ~ 'Not prescribed',
#                                           TRUE~'Other')
#                                 ,levels=levels.Adj3Cat, labels=labels.Adj3Cat)
#
# ,`Adjuvant Biological Therapy`=factor(`Adjuvant Biological Therapy`, levels=levels.AdjuvantTherapies, labels.AdjuvantTherapies)
# ,`Neo-adjuvant Biological Therapy`=factor(`Neo-adjuvant Biological Therapy`, levels=levels.AdjuvantTherapies, labels=labels.AdjuvantTherapies)
# ,AdjBioCategories = case_when(str_detect(`Adjuvant Biological Therapy`, 'Yes') ~ 'Biological Therapy received',
#                               str_detect(`Adjuvant Biological Therapy`, 'Not referred - ') ~ 'No Biological Therapy prescribed',
#                               TRUE~as.character(`Adjuvant Biological Therapy`))
# ,NeoAdjBioCategories=case_when(str_detect(`Neo-adjuvant Biological Therapy`, 'Yes') ~ 'Neo-Adjuvant Biological Therapy received'
#                                , str_detect(`Neo-adjuvant Biological Therapy`, 'Not referred - ') ~ 'No Neo-Adjuvant Biological Therapy prescribed'
#                                ,TRUE~as.character(`Neo-adjuvant Biological Therapy`))
# , `DateOfSurgery`=as_date(`DateOfSurgery`) # Was - Date of Primary Surgery - Naming issue from SQL
# , ChemoReceived=case_when (str_detect(`Adjuvant Chemotherapy`, 'Therapy received') |str_detect(`Neo-adjuvant Chemotherapy`, 'Therapy received') ~ "Chemotherapy received"
#                            ,str_detect(`Adjuvant Chemotherapy`, 'Unknown') |str_detect(`Neo-adjuvant Chemotherapy`, 'Unknown')~"Chemotherapy unknown"
#                            ,TRUE~'No Chemotherapy')
# ,InvasiveTumourSize=as.numeric(InvasiveTumourSize)
# ,AnyBioReceived=factor(case_when(str_detect(`Neo-adjuvant Biological Therapy`, 'Therapy received') ~ 'Neo-adjuvant Therapy received',
#                                  str_detect(`Adjuvant Biological Therapy`, 'Therapy received') ~ 'Adjuvant Therapy received'
#                                  ,(str_detect(`Neo-adjuvant Biological Therapy`, 'Not referred - ') & str_detect(`Adjuvant Biological Therapy`, 'Not referred - ')) ~ 'Treatment not received'
#                                  ,(str_detect(`Neo-adjuvant Biological Therapy`, 'Referred - ') | str_detect(`Adjuvant Biological Therapy`, 'Referred - ')) ~ 'Treatment not received'
#                                  ,TRUE~'Other')
#                        ,levels=levels.AnyBioReceived, labels=labels.AnyBioReceived)
#  adding region
# ,region=factor(region, levels=levels.region, labels=labels.region)
#  adding region_dhb
# ,region_dhb=factor(case_when(DhbOfDiagnosis %in% c("Northland","Auckland","Waitemata","Counties Manukau") ~ "Northern",
#                       DhbOfDiagnosis %in% c("Waikato","Bay of Plenty","Lakes","Taranaki","Tairawhiti")~"Midland",
#                       DhbOfDiagnosis %in% c("Hawkes Bay","Hutt","Capital and Coast","MidCentral","Wairarapa","Whanganui")~"Central",
#                       DhbOfDiagnosis %in% c("Nelson Marlborough","West Coast","Canterbury","South Canterbury","Southern")~"Southern",
# TRUE ~ "Unknown"),levels=levels.region, labels=labels.region)
#  adding dhbs
# ,DhbOfDiagnosis=factor(DhbOfDiagnosis, levels=levels.dhb, labels.dhb)
# add QPI stage calculations
#stage----
,clinical_stage = calculate_stage(t_stage = ClinicalTStage, n_stage = ClinicalNStage, m_stage =ClinicalMStage),
,pathological_stage =  calculate_stage(t_stage = PathologicalTStage, n_stage = PathologicalNStage, m_stage = PathologicalMStage),
#derives overall stage for QPI 11 and 13
# ,overall_stage = case_when(
#   # use all clinical staging when  a patient received neoadjuvant chemotherapy or biological therapy
#   !is.na( `Neoadj-Radiation therapy start date` ) |
#     !is.na(`Neoadj-Biological Start Date`) |
#     # or there is no primary surgery
#     PrimarySurgery == "No" |
#     # or there is any neoadjuvant hormone therapy lasting for longer than 3 months (calculated as whether there is > 90 days from the start of biological therapy until the stop date of therapy OR the first surgery, whichever is sooner)
#     `Neoadj-Hormone Date`!="Less than 12 weeks"  ~ clinical_stage,
#
#   #if no chemo but do have surgery then pathological stage
#   (PrimarySurgery == "Yes" & !is.na(`Neoadj-chemo therapy start date`)) ~ calculate_stage(t_stage = PathologicalTStage, n_stage = choose_stage(PathologicalNStage, ClinicalNStage), m_stage = PathologicalMStage),
#
#   TRUE ~ calculate_stage(t_stage = PathologicalTStage, n_stage = choose_stage(PathologicalNStage, ClinicalNStage), m_stage = PathologicalMStage))
#add variables from Chapter 10
# ,"SLNB Only" = case_when(`Breast Type of Axillary Surgery Group` == "SLNB Only"~"SLNB Only",
#                         TRUE~NA),
# "Level I" = case_when(`Breast Type of Axillary Surgery Group` == "Level I"~"Level I",
#                       TRUE~NA),
# "Level II" = case_when(`Breast Type of Axillary Surgery Group` == "Level II"~"Level II",
#                        TRUE~NA),
# "Level III" = case_when(`Breast Type of Axillary Surgery Group` == "Level III"~"Level III",
#                         TRUE~NA),
# "SLNB + Level I-III" = case_when(`Breast Type of Axillary Surgery Group` == "SLNB + Level I-III"~"SLNB + Level I-III",
#                                  TRUE~NA),
# "Any axillary surgery" = case_when(`Breast Type of Axillary Surgery Group` != "No axillary surgery"~"Any axillary surgery",
#                                    TRUE~NA),
# "No axillary surgery" = case_when(`Breast Type of Axillary Surgery Group` == "No axillary surgery"~"No axillary surgery",
#                                   TRUE~NA),
# "surgery" = case_when(`Breast Type of Axillary Surgery Group` == "SLNB Only"~"SLNB Only", `Breast Type of Axillary Surgery Group` == "No axillary surgery"~"No axillary surgery", TRUE~"Other axillary surgery"),
#
# If_Axillary_Surgery=case_when(`Breast Type of Axillary Surgery Group` %in% c("Declined"
#                                                                           ,"No axillary surgery required"
#                                                                           ,"No axillary surgery")~"No axillary surgery",
#                            TRUE ~ "Any axillary surgery")
)
data_with_vars <- datafile %>%
mutate_at(vars("InvasiveTumourSize"
# ,"DcisTumourSize"
),as.numeric)%>%
#filter(lubridate::year(DateOfTissueDiagnosis)>=2021 & lubridate::year(DateOfTissueDiagnosis)<=2022) %>%
##If the new analyst ahs time - they can make this to into snake case
mutate(
EthnicityGroup = factor(
case_when(EthnicityLevel1 %in% c("Maori", "Pacific") ~ "Maori/Pacific",
TRUE ~ "Other"), levels = c("Maori/Pacific", "Other"), labels = c("M\u101ori/Pacific", "Other"))
,EthnicityGroup2 = factor(
case_when(EthnicityLevel1 %in% c("Maori", "Pacific") ~ "Maori/Pacific",
EthnicityLevel1=="Asian" ~ "Asian",
EthnicityLevel1=="Other" ~ "Other"), levels = c("Maori/Pacific", "Asian","Other"), labels = c("M\u101ori/Pacific", "Asian","Other"))
,MaoriNonMaori=factor(case_when(
EthnicityLevel1 == "Maori" ~ "Māori",  TRUE ~  "Non-Māori" ),levels=levels.MaoriNonMaori ,labels=labels.MaoriNonMaori)
,Ethnicity=factor(case_when(
EthnicityLevel1 == "Maori" ~ "Māori",
EthnicityLevel1 == "Pacific Peoples" ~ "Pacific",
EthnicityLevel1 == "Asian" ~ "Asian",
TRUE ~ "Other") , levels=levels.ethnicity, labels=labels.ethnicity)
,`Referral Source`=factor( case_when(
is.na(SourceOfReferral) |  SourceOfReferral == "Unknown" ~ "Unknown",
SourceOfReferral == "BreastScreen Aotearoa" ~ "Screened BSA",
SourceOfReferral == "Screen detected - non BSA" ~"Screened non-BSA",
TRUE ~ "Non-screening"), levels=levels.ReferralSource, labels=labels.ReferralSource)
,`Referral Source Parent Group`=factor(case_when(
is.na(SourceOfReferral) |  SourceOfReferral == "Unknown" ~ "Unknown",
str_detect(SourceOfReferral, "Screen") | str_detect(SourceOfReferral, "BreastScreen") ~ "Screening",
TRUE ~ "Non-screening"), levels=levels.ScreeningStatus, labels=levels.ScreeningStatus)
# ,`Region BSA Lead Provider` =  factor(case_when(
#   is.na(`BSA Lead Provider name`) | `BSA Lead Provider name`=="" ~ "Unknown",
#   TRUE ~ paste0("Region ",`BSA Lead Provider name`)))
# ,`BSA Lead Provider name` =  factor(case_when(
#   `Referral Source`=="Screened BSA" & is.na(`BSA Lead Provider name`) ~ "Unknown",
#   `Referral Source`=="Screened BSA" & !is.na(`BSA Lead Provider name`)~ `BSA Lead Provider name`,
#   TRUE ~ "" ),levels=levels.provider, labels=labels.provider)
,BSANonBSA=factor(case_when(
is.na(SourceOfReferral) |  SourceOfReferral == "Unknown" ~ "Unknown",
SourceOfReferral == "BreastScreen Aotearoa" ~ "BSA",
TRUE ~ "Non-BSA"), levels=levels.BSANonBSA, labels=levels.BSANonBSA )
,AgeAtTissueDiagnosis = case_when(
#SK confirmed that BSA-detected pxs older than 69 years should be re-coded 69/to be within screening age
AgeAtTissueDiagnosis >69  & SourceOfReferral == "BreastScreen Aotearoa" ~ 69,
TRUE ~ AgeAtTissueDiagnosis)
,`Age Group`=factor(case_when(
AgeAtTissueDiagnosis < 40 ~ "<40",
AgeAtTissueDiagnosis < 45 ~ "40 - 44",
AgeAtTissueDiagnosis < 55 ~ "45 - 54",
AgeAtTissueDiagnosis < 70  ~ "55 - 69",
AgeAtTissueDiagnosis < 75 ~ "70 - 74",
AgeAtTissueDiagnosis >= 75 ~ "75+"), levels=levels.ageBSA, labels=labels.ageBSA )
# ,`New Diagnosis Type`=factor(`New Diagnosis Type`, levels=levels.DiagnosisType, labels=levels.DiagnosisType)
#added the screening age 70 -74
,ScreeningAgeGroups=factor(case_when(AgeAtTissueDiagnosis<=44 ~"<= 44 years", #"<=44"
AgeAtTissueDiagnosis>=45 & AgeAtTissueDiagnosis<70  ~ "Screening age (45-69 years)", #"45-69"
AgeAtTissueDiagnosis>=70 & AgeAtTissueDiagnosis<75 ~ "70-74 years", #"70-74"
TRUE~"75+ years"  ) #"75+"
,levels=levels.ScreeningAge, labels=labels.ScreeningAge) # THIS WAS TAKEN AFTER THE RULE OF SOURCE OF REFERRAL SO IT MAKES SENSE
# diagnosis type----
, new_diagnosis_type = factor(case_when(
#other/unknown diagnosis types
DiagnosisType %in% c("Other breast lesions") ~ "Other/LCIS/Unknown",
#Invasive if Mstage = 1: detectable metastases
(PrimarySurgery == "Yes" & PathologicalMStage == 1) |
(PrimarySurgery == "No"  & ClinicalMStage == 1 ) ~"Invasive",
#Invasive: if  clinicalTstage > 0 else pathologicalTstage   > 0.
(PrimarySurgery == "Yes" & grepl("1|2|3|4",  PathologicalTStage)  ) | (PrimarySurgery == "No" & grepl("1|2|3|4",  ClinicalTStage))  ~"Invasive",
(PathologicStageDescriptorPrefixOrSuffix %in% c("Y", "M & Y") & grepl("1|2|3|4",  ClinicalTStage) ) ~"Invasive",
(PrimarySurgery %in% c("Yes", "No") & (grepl("^1|2|3|^4",  ClinicalTStage)   ) ) ~"Invasive",
#node positive pxs, if clinicalN and pathologicalN > 0
ClinicalTStage %in% c(0, "X")  & grepl("1|2|3",  ClinicalNStage ) ~ "Invasive",
PathologicalTStage %in% c(0, "X")  & grepl("1|2|3",  PathologicalNStage ) ~ "Invasive",
#DCIS if Tstage %in%  'is','is (DCIS)' or DCIS and node positive (Depending on whether they had surgery or not)
PrimarySurgery == "Yes" &  ( PathologicalTStage %in%  c("is (DCIS)", "is" ) & (ClinicalTStage %in%  c(NA, 0, "X", "is (Paget's)") ) )  ~ "DCIS",
#pathological results are given poreference
PathologicStageDescriptorPrefixOrSuffix %in% c("Y", "M & Y")  & ClinicalTStage %in%  c("is (DCIS)", "is" )   ~ "DCIS",
#checks for both pTstage and cTstage
PrimarySurgery  %in% c("Yes",  "No") & ClinicalTStage %in% c("is (DCIS)", "is" ) & PathologicalTStage %in%  c("is (DCIS)", "is" ) ~ "DCIS",
#
PrimarySurgery %in% c("No", "Yes")  &  (ClinicalTStage %in% c("is (DCIS)", "is" ) & (PathologicalTStage %in% c(NA, 0, "X", "is (Paget's)") )) ~ "DCIS",
TRUE ~ "Other/LCIS/Unknown") , levels=c("DCIS", "Invasive", "Other/LCIS/Unknown"), ordered = TRUE  ),
#rurality status----
##Hazem: replace NAs with unknown  for rurality and deprivation codes
#uses 2001_rural for rurality code description. Code urban = 0, semi-rulal = 1, rural = 2, remote-rural = 3
rurality_status = factor(case_when(
is.na(rurality_codes) ~ "Unknown",
TRUE ~ rurality_codes ),  levels = c("U1", "U2", "R1","R2","R3","Unknown"), ordered = TRUE),
#depriviation----
#quintile derivation based on the domMap: least to more deprived
deprivation = factor(case_when(
deprivation_decile %in% c(1,2) ~ "Quintile 1",
deprivation_decile %in% c(3,4) ~ "Quintile 2",
deprivation_decile %in% c(5,6) ~ "Quintile 3",
deprivation_decile %in% c(7,8) ~ "Quintile 4",
deprivation_decile %in% c(9,10) ~ "Quintile 5",
is.na(deprivation_decile) ~  "Unknown"), levels = c("Quintile 1", "Quintile 2", "Quintile 3", "Quintile 4", "Quintile 5", "Unknown"), ordered = TRUE)
,`Private or Public` = if_else(
substr(Clinic, 1, 1) %in% c("1", "2", "3", "4", "5", "6", "7"), "Public","Private")
# ,`Adjuvant Chemotherapy`=factor(`Adjuvant Chemotherapy`)
,`ER Positive` = if_else(
CoreBiopsyOestrogenResult %in% c(NA, "Not assessable", "Not tested", "Unknown", "zN\\A") & !is.na(OestrogenResult),
OestrogenResult,  CoreBiopsyOestrogenResult)
,`PR Positive` = if_else(
CoreBiopsyProgesteroneResult %in% c(NA, "Not assessable", "Not tested", "Unknown", "zN\\A") & !is.na(ProgesteroneResult),
ProgesteroneResult,     CoreBiopsyProgesteroneResult)
,MorphologyOfInvasiveCarcinomahistologicalType=
factor(case_when(!is.na(MorphologyOfInvasiveCarcinomahistologicalType)~MorphologyOfInvasiveCarcinomahistologicalType,
PrimarySurgery=="No"~"No breast surgery"
,TRUE~"NA")
,levels=levels.TumourType)
# ,MenopausalStatus=factor(MenopausalStatus,levels=levels.Menopausal)
,`Size of invasive tumour group` = factor(case_when(
InvasiveTumourSize == 0 | is.na(InvasiveTumourSize)| InvasiveTumourSize == 999 ~ "",
InvasiveTumourSize <=1 ~ "Micro Invasion" ,
InvasiveTumourSize  < 10 ~ "<10 mm"   ,
InvasiveTumourSize <=14 ~ "10-14 mm" ,
InvasiveTumourSize <=19 ~ "15-19 mm" ,
InvasiveTumourSize <=29 ~ "20-29 mm" ,
InvasiveTumourSize  <= 39~ "30-39 mm" ,
InvasiveTumourSize >= 40 ~ ">=40 mm" ), levels=levels.GroupedInvasiveTumourSize)
# ,Mets=case_when(!is.na(`Earliest Mets`) ~ "Yes", TRUE~"No")
# ,NodalInvolve=factor(case_when(!is.na(`NodalMetastasisBasedOnTheLargestDeposit`)~`NodalMetastasisBasedOnTheLargestDeposit`,
#                                is.na(`NumberOfNodesInvolvedByTumour`)~"No nodal involvement",
#                                `NumberOfNodesInvolvedByTumour`==0 ~"No nodal involvement",
#                                `New Diagnosis Type`=="DCIS"~"Not Invasive",
#                                TRUE~"Missing"),levels=levels.NodalInvolved)
# ,`Pathological prognostic stage`=case_when (!is.na(`Overall Tnm Stage`)~`Overall Tnm Stage`,
# TRUE ~ "Not applicable")
# ,PathGroup=case_when(
#   str_detect(`Pathological prognostic stage`, "1") ~ "Stage 1",
#   str_detect(`Pathological prognostic stage`, "2") ~ "Stage 2",
#   str_detect(`Pathological prognostic stage`, "3") ~ "Stage 3",
#   str_detect(`Pathological prognostic stage`, "4") ~ "Stage 4",
#   TRUE~`Pathological prognostic stage` )
,HistologicalInvasiveCancerGrade=factor(case_when(HistologicalInvasiveCancerGrade=="1" ~ "Grade 1",
HistologicalInvasiveCancerGrade=="2" ~ "Grade 2",
HistologicalInvasiveCancerGrade=="3" ~ "Grade 3",
TRUE~HistologicalInvasiveCancerGrade) ,levels=levels.Grade)
# ,`High risk`=factor(`High risk`, levels=levels.yesno, labels=levels.yesno)
# ,`Grouped DCIS Tumour Size` = factor(case_when(
#   is.na(DcisTumourSize) | DcisTumourSize == 0 ~ "Unknown",
#   DcisTumourSize < 10 ~ "<10mm",
#   DcisTumourSize < 15 ~ "10-14mm",
#   DcisTumourSize < 20 ~ "15-19mm",
#   DcisTumourSize < 30 ~ "20-29mm",
#   DcisTumourSize < 40 ~ "30-39mm",
#   DcisTumourSize >= 40 ~ ">=40mm"),  levels.GroupedDcisTumourSize, labels=labels.GroupedDcisTumourSize)
,PrimarySurgery=factor(PrimarySurgery, levels=levels.yesno, labels=levels.yesno)
# ,HighestDcisGrade=factor(HighestDcisGrade, levels=levels.DCISGrade, labels=levels.DCISGrade)
,DiagnosisYear = format(DateOfTissueDiagnosis, format="%Y")
# ,`If Neoadjuvant`=factor(`If Neoadjuvant`,levels=levels.yesno)
,TimetoSurgery=as.Date(`DateOfSurgery`)-as.Date(`DateOfTissueDiagnosis`)
# ,TimetoSurgeryGroup=case_when(`If Neoadjuvant`=="Yes" ~ "Neo-adjuvant treatment",
#                               PrimarySurgery=="No" ~ "No primary surgery",
#                               TimetoSurgery<0 ~ "Surgery before diagnosis",
#                               TimetoSurgery<=31 ~ "0-31 Days",
#                               TimetoSurgery<=62 ~ "32-62 Days",
#                               TimetoSurgery>=63 ~ "63+ Days" )
#
# ,`Time to Neo` = ifelse(
#   `If Neoadjuvant` == "Yes",
#   as.numeric(pmin(`Neoadj-Biological Start Date`,
#                   `Neoadj-chemo therapy start date`,
#                   `Neoadj-Hormone Start Date`,
#                   `Neoadj-Radiation therapy start date`, na.rm = TRUE) - DateOfTissueDiagnosis),
#   NA_real_ ) # Ensure the column is numeric, so NA should be numeric as well
# ,TimetoNeoGroup=case_when(`If Neoadjuvant`=="No" ~ "No Neo-adjuvant treatment",
#                           `Time to Neo`<0 ~ "Neo before diagnosis",
#                           `Time to Neo`<=31 ~ "0-31 Days",
#                           `Time to Neo`<=62 ~ "32-62 Days",
#                           `Time to Neo`>=63 ~ "63+ Days",
#                           TRUE ~ "Date not valid" )
# ,TOFTDays=case_when(`31 Days Indicator`<0 ~ "FCT before DTT",
#                     `31 Days Indicator`<=31 ~ "0-31 Days",
#                     `31 Days Indicator`>31 ~ "32+ Days",
#                     `31 Days Indicator`=="NA" ~ "Date not accessible" )
# ,Treatment=case_when(`If Neoadjuvant`=="Yes" ~ "Neo-adjuvant treatment",
#                      PrimarySurgery=="Yes" ~ "Primary Surgery",
#                      TRUE ~ "No Treatment" )
# ,DecisiontoFirst=as.Date(`DateofFirstCancerTreatment`)-as.Date(`DateOfDecisionToTreat`)
# ,DecisiontoFirstTreatment=case_when(DecisiontoFirst<0 ~ "FCT before DTT",
#                                     DecisiontoFirst<=31 ~ "0-31 Days",
#                                     DecisiontoFirst<=62 ~ "32-62 Days",
#                                     DecisiontoFirst>=63 ~ "63+ Days",
#                                     TRUE ~ "Date not valid" )
# ,DiagnosistoTreatment=as.Date(`DateofFirstCancerTreatment`)-as.Date(`DateOfTissueDiagnosis`) # ADDED FOR CHP7
# ,DiagnosistoTreatmentgroup=case_when(DiagnosistoTreatment<0 ~ "Treatment before Diagnosis",  # ADDED FOR CHP7
#                                      DiagnosistoTreatment<=31 ~ "0-31 Days",
#                                      DiagnosistoTreatment<=62 ~ "32-62 Days",
#                                      DiagnosistoTreatment>=63 ~ "63+ Days",
#                                      TRUE ~ "Date not valid")
,DecisiontoSurg=as.Date(`DateOfSurgery`)-as.Date(`DateOfDecisionToTreat`)
# ,DecisiontoFirstSurgery=case_when(`If Neoadjuvant`=="Yes" ~ "Neo-adjuvant treatment",
#                                   DecisiontoSurg<0 ~ "Surgery before Decision to Treat",
#                                   DecisiontoSurg<=31 ~ "0-31 Days",
#                                   DecisiontoSurg<=62 ~ "32-62 Days",
#                                   DecisiontoSurg>=63 ~ "63+ Days",
#                                   TRUE ~ "Date not valid" )
# ,`Breast Type of Breast Surgery`=factor(case_when(PrimarySurgery=="No"~"No primary surgery",
#                                                   TRUE~`Breast Type of Breast Surgery`), levels=levels.SurgeryType, labels=labels.SurgeryType)
# ,`Final Breast Type of Breast Surgery`=factor(case_when(PrimarySurgery=="No"~"No primary surgery",
#                                                         TRUE~`Final Breast Type of Breast Surgery`), levels=levels.SurgeryType, labels=labels.SurgeryType)
# ,`Reconstruction after Mastectomy`=factor(`Reconstruction after Mastectomy`, levels=levels.Reconstruction, labels=levels.Reconstruction)
# ,AnyFurtherSurgery=case_when(`FurtherSurgeryAfterBCS`=="No"~"No further breast surgery",
#                              TRUE~"Any further surgery")
# ,`Breast Type of Axillary Surgery Group`=factor(`Breast Type of Axillary Surgery Group`, levels=levels.Axillary, labels=labels.Axillary)
# ,InvasiveMarginGroup=factor( case_when(
#   `InvasiveClosestCircumferentialMargin`==0 ~"Involved margin",
#   `InvasiveClosestCircumferentialMargin`<1 ~"1mm margin",
#   `InvasiveClosestCircumferentialMargin`<99 ~">=2mm margin",
#   `InvasiveClosestCircumferentialMargin`==99 &`ResectionMarginInvasiveInSitu`=="Negative"~">=2mm margin",
#   `InvasiveClosestCircumferentialMargin` ==999 & `ResectionMarginInvasiveInSitu`=="Negative"
# ~ "Clear but unspecified margin",
# is.na(`InvasiveClosestCircumferentialMargin`) & `ResectionMarginInvasiveInSitu`=="Negative"
# ~ "Clear but unspecified margin",
# `InvasiveClosestCircumferentialMargin` %in% c(99,999) & `ResectionMarginInvasiveInSitu`=="Positive" ~"Involved margin",
# is.na(`InvasiveClosestCircumferentialMargin`) & `ResectionMarginInvasiveInSitu`=="Positive" ~"Involved margin",
# `InvasiveTumourSize`==0 & `ResectionMarginInvasiveInSitu`=="Negative" ~ "Clear but unspecified margin",
# PrimarySurgery=="No" ~ "No primary surgery",
# is.na(`InvasiveClosestCircumferentialMargin`) ~ "No Margin" )
# ,levels=levels.MarginGroup)
# ,DCISMarginGroup=factor(case_when(
#   `DcisClosestCircumferentialMargin`==0 ~"Involved margin",
#   `DcisClosestCircumferentialMargin`<1 ~"1mm margin",
#   `DcisClosestCircumferentialMargin`<99 ~">=2mm margin",
#   `DcisClosestCircumferentialMargin`==99 &`ResectionMarginInvasiveInSitu`=="Negative"~">=2mm margin",
#   `DcisClosestCircumferentialMargin` ==999 & `ResectionMarginInvasiveInSitu`=="Negative" ~"Clear but unspecified margin",
#   is.na(`DcisClosestCircumferentialMargin`) & `ResectionMarginInvasiveInSitu`=="Negative" ~"Clear but unspecified margin",
#   `DcisClosestCircumferentialMargin` %in% c(99,999) & `ResectionMarginInvasiveInSitu`=="Positive" ~"Involved margin",
#   is.na(`DcisClosestCircumferentialMargin`) & `ResectionMarginInvasiveInSitu`=="Positive" ~"Involved margin",
#   `DcisTumourSize`==0 & `ResectionMarginInvasiveInSitu`=="Negative" ~ "Clear but unspecified margin",
#   PrimarySurgery=="No" ~ "No primary surgery",
#   is.na(`DcisClosestCircumferentialMargin`) ~ "No Margin")
#   ,levels=levels.MarginGroup)
# ,`Adjuvant Radiation Therapy`=factor(`Adjuvant Radiation Therapy`, levels=levels.AdjuvantTherapies, labels=labels.AdjuvantTherapies)
# ,AdjRadioCategories = factor(case_when(str_detect(`Adjuvant Radiation Therapy`, 'Therapy received') ~ 'Therapy received',
#                                        str_detect(`Adjuvant Radiation Therapy`, 'Referred - ') ~ 'Referred but not used',
#                                        str_detect(`Adjuvant Radiation Therapy`, 'Not referred - ') ~ 'Not prescribed',
#                                        TRUE~'Other')
#                              ,levels.Adj3Cat, label=labels.Adj3Cat)
# ,MdtSurgeries=case_when(str_detect(MdtAgreedPlannedCancerTreatment, '6')~'MDT Surgery',
#                         TRUE~'MDT - Not surgery')
,SurgeryDateDefined=case_when(is.na(`DateOfSurgery`)~'Surgery date missing',
TRUE~'Surgery date recorded')
# ,TimeBetweenNeoStartAndSurgery=floor(as.numeric(difftime(`DateOfSurgery`, `Neoadj-Hormone Start Date`, units='weeks')))
# ,EndoBridge=factor(case_when(TimeBetweenNeoStartAndSurgery<=12 ~ 'Yes',
#                              `Neo-adjuvant Hormone Therapy`%in% c('Yes','Therapy received')
#                              & TimeBetweenNeoStartAndSurgery>12
#                              & MdmCancerPlanIntent=='Curative'
#                              & str_detect(MdtAgreedPlannedCancerTreatment, '6')
#                              & !(is.na(`DateOfSurgery`)) ~ 'Yes',
#                              `Neo-adjuvant Hormone Therapy`%in% c('Yes','Therapy received')~'Not bridge',
#                              TRUE~'No Neo-adjuvant Endocrine Therapy')
#                    ,levels=levels.EndoBridge, labels=labels.EndoBridge)
# ,HormoCatWithAblation=case_when(str_detect(`Ovarian Ablation`, 'Yes')  ~ 'Yes',
#                                 TRUE~`Adjuvant Hormone Therapy`)
# ,AdjHormoCat = factor(case_when(str_detect(HormoCatWithAblation, 'Yes') ~ 'Therapy received',
#                                 str_detect(HormoCatWithAblation, 'Referred - ') ~ 'Referred but not used',
#                                 str_detect(HormoCatWithAblation, 'Not referred - ') ~ 'Not prescribed',
#                                 TRUE~'Other'), levels=levels.Adj3Cat, labels=labels.Adj3Cat)
,`Adjuvant Hormone Therapy`=factor(`AdjuvantHormoneTherapy`, levels=levels.AdjuvantTherapies, labels=labels.AdjuvantTherapies)
# ,HER2Result=factor(HER2Result)
# ,`Ovarian Ablation`=factor(`Ovarian Ablation`)
# ,AdjChemoCategories = factor(case_when(`Adjuvant Chemotherapy` %in% c('Yes', 'Therapy received') ~ 'Therapy received',
#                                        str_detect(`Adjuvant Chemotherapy`, 'Referred - ') ~ 'Referred but not used',
#                                        str_detect(`Adjuvant Chemotherapy`, 'Not referred - ') ~ 'Not prescribed',
#                                        TRUE~'Other')
#                              ,levels=levels.Adj3Cat, labels=labels.Adj3Cat)
# ,`Adjuvant Chemotherapy`=factor(`Adjuvant Chemotherapy`, levels=levels.AdjuvantTherapies, labels=labels.AdjuvantTherapies)
# ,`Neo-adjuvant Radiation Therapy`=factor(`Neo-adjuvant Radiation Therapy`)
# ,NeoAdjRadioCategories = case_when(str_detect(`Neo-adjuvant Radiation Therapy`, 'Yes') ~ 'Radiotherapy  received',
#                                    str_detect(`Neo-adjuvant Radiation Therapy`, 'Referred - ') ~ 'Referred but not used',
#                                    str_detect(`Neo-adjuvant Radiation Therapy`, 'Not referred - ') ~ 'No Radiotherapy prescribed',
#                                    TRUE~'Other')
# ,TimeBetweenNeoStartAndSurgery=floor(as.numeric(difftime(`DateOfSurgery`, `Neoadj-Hormone Start Date`, units='weeks')))
# ,NeoAdjHormoCat = factor(case_when(str_detect(`Neo-adjuvant Hormone Therapy`, 'Yes') ~ "Therapy received",
#                                    str_detect(`Neo-adjuvant Hormone Therapy`, 'Referred - ')   ~ "Referred but not used",
#                                    str_detect(`Neo-adjuvant Hormone Therapy`, 'Not referred - ') ~ "Not prescribed",
#                                    TRUE~"Other")
#                          ,levels=levels.Adj3Cat, labels=labels.Adj3Cat)
# ,`Neo-adjuvant Hormone Therapy`=factor(`Neo-adjuvant Hormone Therapy`, levels = levels.AdjuvantHormoneTherapies, labels=labels.AdjuvantHormoneTherapies)
# ,`Neo-adjuvant Chemotherapy`=factor(`Neo-adjuvant Chemotherapy`, levels=levels.AdjuvantTherapies, labels=labels.AdjuvantTherapies)
# ,NeoAdjChemoCategories = factor(case_when(str_detect(`Neo-adjuvant Chemotherapy`, 'Yes')|str_detect(`Neo-adjuvant Chemotherapy`, 'Therapy received') ~ 'Therapy received',
#                                           str_detect(`Neo-adjuvant Chemotherapy`, 'Referred - ') ~ 'Referred but not used',
#                                           str_detect(`Neo-adjuvant Chemotherapy`, 'Not referred - ') ~ 'Not prescribed',
#                                           TRUE~'Other')
#                                 ,levels=levels.Adj3Cat, labels=labels.Adj3Cat)
#
# ,`Adjuvant Biological Therapy`=factor(`Adjuvant Biological Therapy`, levels=levels.AdjuvantTherapies, labels.AdjuvantTherapies)
# ,`Neo-adjuvant Biological Therapy`=factor(`Neo-adjuvant Biological Therapy`, levels=levels.AdjuvantTherapies, labels=labels.AdjuvantTherapies)
# ,AdjBioCategories = case_when(str_detect(`Adjuvant Biological Therapy`, 'Yes') ~ 'Biological Therapy received',
#                               str_detect(`Adjuvant Biological Therapy`, 'Not referred - ') ~ 'No Biological Therapy prescribed',
#                               TRUE~as.character(`Adjuvant Biological Therapy`))
# ,NeoAdjBioCategories=case_when(str_detect(`Neo-adjuvant Biological Therapy`, 'Yes') ~ 'Neo-Adjuvant Biological Therapy received'
#                                , str_detect(`Neo-adjuvant Biological Therapy`, 'Not referred - ') ~ 'No Neo-Adjuvant Biological Therapy prescribed'
#                                ,TRUE~as.character(`Neo-adjuvant Biological Therapy`))
# , `DateOfSurgery`=as_date(`DateOfSurgery`) # Was - Date of Primary Surgery - Naming issue from SQL
# , ChemoReceived=case_when (str_detect(`Adjuvant Chemotherapy`, 'Therapy received') |str_detect(`Neo-adjuvant Chemotherapy`, 'Therapy received') ~ "Chemotherapy received"
#                            ,str_detect(`Adjuvant Chemotherapy`, 'Unknown') |str_detect(`Neo-adjuvant Chemotherapy`, 'Unknown')~"Chemotherapy unknown"
#                            ,TRUE~'No Chemotherapy')
# ,InvasiveTumourSize=as.numeric(InvasiveTumourSize)
# ,AnyBioReceived=factor(case_when(str_detect(`Neo-adjuvant Biological Therapy`, 'Therapy received') ~ 'Neo-adjuvant Therapy received',
#                                  str_detect(`Adjuvant Biological Therapy`, 'Therapy received') ~ 'Adjuvant Therapy received'
#                                  ,(str_detect(`Neo-adjuvant Biological Therapy`, 'Not referred - ') & str_detect(`Adjuvant Biological Therapy`, 'Not referred - ')) ~ 'Treatment not received'
#                                  ,(str_detect(`Neo-adjuvant Biological Therapy`, 'Referred - ') | str_detect(`Adjuvant Biological Therapy`, 'Referred - ')) ~ 'Treatment not received'
#                                  ,TRUE~'Other')
#                        ,levels=levels.AnyBioReceived, labels=labels.AnyBioReceived)
#  adding region
# ,region=factor(region, levels=levels.region, labels=labels.region)
#  adding region_dhb
# ,region_dhb=factor(case_when(DhbOfDiagnosis %in% c("Northland","Auckland","Waitemata","Counties Manukau") ~ "Northern",
#                       DhbOfDiagnosis %in% c("Waikato","Bay of Plenty","Lakes","Taranaki","Tairawhiti")~"Midland",
#                       DhbOfDiagnosis %in% c("Hawkes Bay","Hutt","Capital and Coast","MidCentral","Wairarapa","Whanganui")~"Central",
#                       DhbOfDiagnosis %in% c("Nelson Marlborough","West Coast","Canterbury","South Canterbury","Southern")~"Southern",
# TRUE ~ "Unknown"),levels=levels.region, labels=labels.region)
#  adding dhbs
# ,DhbOfDiagnosis=factor(DhbOfDiagnosis, levels=levels.dhb, labels.dhb)
# add QPI stage calculations
#stage----
,clinical_stage = calculate_stage(t_stage = ClinicalTStage, n_stage = ClinicalNStage, m_stage =ClinicalMStage),
,pathological_stage =  calculate_stage(t_stage = PathologicalTStage, n_stage = PathologicalNStage, m_stage = PathologicalMStage),
#derives overall stage for QPI 11 and 13
# ,overall_stage = case_when(
#   # use all clinical staging when  a patient received neoadjuvant chemotherapy or biological therapy
#   !is.na( `Neoadj-Radiation therapy start date` ) |
#     !is.na(`Neoadj-Biological Start Date`) |
#     # or there is no primary surgery
#     PrimarySurgery == "No" |
#     # or there is any neoadjuvant hormone therapy lasting for longer than 3 months (calculated as whether there is > 90 days from the start of biological therapy until the stop date of therapy OR the first surgery, whichever is sooner)
#     `Neoadj-Hormone Date`!="Less than 12 weeks"  ~ clinical_stage,
#
#   #if no chemo but do have surgery then pathological stage
#   (PrimarySurgery == "Yes" & !is.na(`Neoadj-chemo therapy start date`)) ~ calculate_stage(t_stage = PathologicalTStage, n_stage = choose_stage(PathologicalNStage, ClinicalNStage), m_stage = PathologicalMStage),
#
#   TRUE ~ calculate_stage(t_stage = PathologicalTStage, n_stage = choose_stage(PathologicalNStage, ClinicalNStage), m_stage = PathologicalMStage))
#add variables from Chapter 10
# ,"SLNB Only" = case_when(`Breast Type of Axillary Surgery Group` == "SLNB Only"~"SLNB Only",
#                         TRUE~NA),
# "Level I" = case_when(`Breast Type of Axillary Surgery Group` == "Level I"~"Level I",
#                       TRUE~NA),
# "Level II" = case_when(`Breast Type of Axillary Surgery Group` == "Level II"~"Level II",
#                        TRUE~NA),
# "Level III" = case_when(`Breast Type of Axillary Surgery Group` == "Level III"~"Level III",
#                         TRUE~NA),
# "SLNB + Level I-III" = case_when(`Breast Type of Axillary Surgery Group` == "SLNB + Level I-III"~"SLNB + Level I-III",
#                                  TRUE~NA),
# "Any axillary surgery" = case_when(`Breast Type of Axillary Surgery Group` != "No axillary surgery"~"Any axillary surgery",
#                                    TRUE~NA),
# "No axillary surgery" = case_when(`Breast Type of Axillary Surgery Group` == "No axillary surgery"~"No axillary surgery",
#                                   TRUE~NA),
# "surgery" = case_when(`Breast Type of Axillary Surgery Group` == "SLNB Only"~"SLNB Only", `Breast Type of Axillary Surgery Group` == "No axillary surgery"~"No axillary surgery", TRUE~"Other axillary surgery"),
#
# If_Axillary_Surgery=case_when(`Breast Type of Axillary Surgery Group` %in% c("Declined"
#                                                                           ,"No axillary surgery required"
#                                                                           ,"No axillary surgery")~"No axillary surgery",
#                            TRUE ~ "Any axillary surgery")
)
#includes all eligibility status, diagnosis types as well
data_all_pxs <- data_with_vars
save(data_all_pxs,
# data_screening_age, data_70upto74,data_historical_screening_age,
file = here(paste0("./Input/Impact_data_",format(Sys.Date(),"%b"),"Extr.RData")))
write.csv(data_all_pxs, file= here("./Input","data_all_pxs_2020_2022.csv"))
View(data_all_pxs)
